name: Flutter Build and Release

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  build-and-release:
    if: github.event.pull_request.merged == true
    runs-on: windows-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'
          channel: 'stable'
          cache: true
          
      - name: Get dependencies
        run: flutter pub get
        
      - name: Build Debug
        run: flutter build windows --debug
        
      - name: Build Profile  
        run: flutter build windows --profile
        
      - name: Build Release
        run: flutter build windows --release
        
      - name: Get current date
        id: date
        run: echo "date=$(Get-Date -Format 'yyyy-MM-dd')" >> $env:GITHUB_OUTPUT
        shell: pwsh
        
      - name: Create archives
        run: |
          # Create debug archive
          Compress-Archive -Path "build\windows\x64\runner\Debug\*" -DestinationPath "bilizen-windows-debug-${{ steps.date.outputs.date }}.zip"
          
          # Create profile archive
          Compress-Archive -Path "build\windows\x64\runner\Profile\*" -DestinationPath "bilizen-windows-profile-${{ steps.date.outputs.date }}.zip"
          
          # Create release archive
          Compress-Archive -Path "build\windows\x64\runner\Release\*" -DestinationPath "bilizen-windows-release-${{ steps.date.outputs.date }}.zip"
        shell: pwsh
        
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.date.outputs.date }}
          name: "Bilizen Release ${{ steps.date.outputs.date }}"
          body: |
            ğŸš€ è‡ªåŠ¨æ„å»ºå‘å¸ƒ - ${{ steps.date.outputs.date }}
            
            æœ¬æ¬¡å‘å¸ƒåŒ…å«ä»¥ä¸‹æ„å»ºäº§ç‰©ï¼š
            - **Debugç‰ˆæœ¬**: ç”¨äºå¼€å‘å’Œè°ƒè¯•ï¼ŒåŒ…å«è°ƒè¯•ä¿¡æ¯
            - **Profileç‰ˆæœ¬**: æ€§èƒ½åˆ†æç‰ˆæœ¬ï¼Œä¿ç•™éƒ¨åˆ†è°ƒè¯•ä¿¡æ¯
            - **Releaseç‰ˆæœ¬**: ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬ï¼Œç»è¿‡ä¼˜åŒ–
            
            ## å˜æ›´å†…å®¹
            æœ¬æ¬¡å‘å¸ƒåŸºäºPR: #${{ github.event.pull_request.number }}
            ${{ github.event.pull_request.title }}
            
          files: |
            bilizen-windows-debug-${{ steps.date.outputs.date }}.zip
            bilizen-windows-profile-${{ steps.date.outputs.date }}.zip
            bilizen-windows-release-${{ steps.date.outputs.date }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
